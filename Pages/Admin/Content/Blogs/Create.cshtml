@page
@model TaxHelperToday.Pages.Admin.Content.Blogs.CreateModel
@{
    ViewData["Title"] = "Create Blog Post";
    Layout = "~/Pages/Admin/_AdminLayout.cshtml";
}

<section class="content-header">
    <div class="container-fluid">
        <div class="row mb-2">
            <div class="col-sm-6">
                <h1>Create Blog Post</h1>
            </div>
            <div class="col-sm-6">
                <ol class="breadcrumb float-sm-right">
                    <li class="breadcrumb-item"><a href="/Admin/Dashboard">Home</a></li>
                    <li class="breadcrumb-item"><a href="/Admin/Content/Blogs">Blogs</a></li>
                    <li class="breadcrumb-item active">Create</li>
                </ol>
            </div>
        </div>
    </div>
</section>

<section class="content">
    <div class="container-fluid">
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">New Blog Post</h3>
                    </div>
                    <form method="post" enctype="multipart/form-data">
                        <div class="card-body">
                            @if (!ViewData.ModelState.IsValid)
                            {
                                <div class="alert alert-danger">
                                    <ul class="mb-0">
                                        @foreach (var error in ViewData.ModelState.Values.SelectMany(v => v.Errors))
                                        {
                                            <li>@error.ErrorMessage</li>
                                        }
                                    </ul>
                                </div>
                            }

                            <div class="form-group">
                                <label asp-for="BlogPost.Slug">Slug <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" asp-for="BlogPost.Slug" placeholder="e.g., tax-saving-tips-2024" required>
                                <span asp-validation-for="BlogPost.Slug" class="text-danger"></span>
                                <small class="form-text text-muted">URL-friendly identifier (lowercase, hyphens only)</small>
                            </div>

                            <div class="form-group">
                                <label asp-for="BlogPost.Title">Title <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" asp-for="BlogPost.Title" placeholder="Enter blog post title" required>
                                <span asp-validation-for="BlogPost.Title" class="text-danger"></span>
                            </div>

                            <div class="form-group">
                                <label asp-for="BlogPost.Excerpt">Excerpt</label>
                                <textarea class="form-control" asp-for="BlogPost.Excerpt" rows="3" placeholder="Short summary of the blog post"></textarea>
                                <span asp-validation-for="BlogPost.Excerpt" class="text-danger"></span>
                                <small class="form-text text-muted">Brief summary shown in blog listings</small>
                            </div>

                            <div class="form-group">
                                <label asp-for="BlogPost.Content">Content <span class="text-danger">*</span></label>
                                <div id="blogContent" style="min-height: 400px;">
                                    @Html.Raw(Model.BlogPost?.Content ?? "")
                                </div>
                                <textarea asp-for="BlogPost.Content" style="display: none;"></textarea>
                                <span asp-validation-for="BlogPost.Content" class="text-danger"></span>
                                <small class="form-text text-muted">Use the rich text editor to format your content</small>
                            </div>

                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label asp-for="BlogPost.Category">Category</label>
                                        <input type="text" class="form-control" asp-for="BlogPost.Category" placeholder="e.g., Tax Planning, ITR, GST">
                                        <span asp-validation-for="BlogPost.Category" class="text-danger"></span>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label asp-for="BlogPost.ReadTime">Read Time</label>
                                        <input type="text" class="form-control" asp-for="BlogPost.ReadTime" placeholder="e.g., 5 min read">
                                        <span asp-validation-for="BlogPost.ReadTime" class="text-danger"></span>
                                    </div>
                                </div>
                            </div>

                            <div class="form-group">
                                <label asp-for="FeaturedImageFile">Featured Image</label>
                                <input type="file" class="form-control" asp-for="FeaturedImageFile" accept="image/*">
                                <div id="featuredImagePreviewContainer" class="mt-2" style="display:none;">
                                    <img id="featuredImagePreview" src="#" alt="Featured image preview" style="max-height: 120px; border: 1px solid #ddd; padding: 4px; border-radius: 4px;" />
                                </div>
                                <span asp-validation-for="FeaturedImageFile" class="text-danger"></span>
                                <small class="form-text text-muted">Upload a featured image (JPG/PNG/WebP/GIF). Optional.</small>
                            </div>

                            <div class="form-group">
                                <label asp-for="BlogPost.MetaDescription">Meta Description</label>
                                <textarea class="form-control" asp-for="BlogPost.MetaDescription" rows="2" placeholder="SEO meta description (150-160 characters recommended)"></textarea>
                                <span asp-validation-for="BlogPost.MetaDescription" class="text-danger"></span>
                                <small class="form-text text-muted">Used for SEO and social media sharing</small>
                            </div>

                            <div class="form-group">
                                <label asp-for="BlogPost.MetaKeywords">Meta Keywords</label>
                                <input type="text" class="form-control" asp-for="BlogPost.MetaKeywords" placeholder="tax, itr, gst, compliance">
                                <span asp-validation-for="BlogPost.MetaKeywords" class="text-danger"></span>
                                <small class="form-text text-muted">Comma-separated keywords for SEO</small>
                            </div>

                            <div class="form-group">
                                <label asp-for="TagsInput">Tags <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" asp-for="TagsInput" placeholder="Enter tags separated by commas (e.g., tax, itr, planning)" required>
                                <span asp-validation-for="TagsInput" class="text-danger"></span>
                                <small class="form-text text-muted">Comma-separated tags for categorization</small>
                            </div>

                            <div class="form-group">
                                <div class="form-check">
                                    <input type="checkbox" class="form-check-input" asp-for="BlogPost.IsPublished">
                                    <label class="form-check-label" asp-for="BlogPost.IsPublished">
                                        Publish immediately
                                    </label>
                                </div>
                                <small class="form-text text-muted">If unchecked, the post will be saved as a draft</small>
                            </div>
                        </div>
                        <div class="card-footer">
                            <button type="submit" class="btn btn-primary" id="createBlogBtn">
                                <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true" id="createBlogSpinner"></span>
                                <i class="fas fa-save" id="createBlogIcon"></i> Create Blog Post
                            </button>
                            <a href="/Admin/Content/Blogs" class="btn btn-secondary">
                                <i class="fas fa-times"></i> Cancel
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</section>

@section Styles {
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
}

@section Scripts {
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-validation/1.19.3/jquery.validate.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-validation-unobtrusive/3.2.12/jquery.validate.unobtrusive.min.js"></script>
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    <script>
        $(document).ready(function() {
            // Initialize Quill editor
            var quill = new Quill('#blogContent', {
                theme: 'snow',
                modules: {
                    toolbar: [
                        [{ 'header': [1, 2, 3, 4, 5, 6, false] }],
                        ['bold', 'italic', 'underline', 'strike'],
                        [{ 'color': [] }, { 'background': [] }],
                        [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                        [{ 'align': [] }],
                        ['link', 'image'],
                        ['clean'],
                        ['code-block']
                    ]
                },
                placeholder: 'Enter blog post content...'
            });

            // Update the hidden textarea before form submission
            $('form').on('submit', function() {
                var content = document.querySelector('#blogContent .ql-editor').innerHTML;
                $('textarea[name="BlogPost.Content"]').val(content);
                
                // Show spinner and hide icon
                const createBtn = document.getElementById('createBlogBtn');
                const spinner = document.getElementById('createBlogSpinner');
                const icon = document.getElementById('createBlogIcon');
                
                if (createBtn && spinner && icon) {
                    spinner.classList.remove('d-none');
                    icon.classList.add('d-none');
                    createBtn.disabled = true;
                }
            });

            // Featured image preview
            const fileInput = document.querySelector('input[name="FeaturedImageFile"]');
            const previewContainer = document.getElementById('featuredImagePreviewContainer');
            const previewImage = document.getElementById('featuredImagePreview');

            if (fileInput && previewContainer && previewImage) {
                fileInput.addEventListener('change', function (event) {
                    const file = event.target.files && event.target.files[0];
                    if (!file) {
                        previewContainer.style.display = 'none';
                        previewImage.src = '#';
                        return;
                    }

                    const reader = new FileReader();
                    reader.onload = function (e) {
                        previewImage.src = e.target.result;
                        previewContainer.style.display = 'block';
                    };
                    reader.readAsDataURL(file);
                });
            }
        });
    </script>
}
